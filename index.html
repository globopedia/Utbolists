<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Buscador de Futbolistas – Huracán</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  margin: 0;
  padding: 12px;
}

#buscador {
  width: 100%;
  max-width: 420px;
  padding: 8px;
  font-size: 16px;
}

#sugerencias {
  max-width: 420px;
  border: 1px solid #ccc;
  border-top: none;
}

.sugerencia {
  padding: 6px 8px;
  cursor: pointer;
}

.sugerencia:hover,
.sugerencia.activa {
  background: #eee;
}

#ficha {
  margin-top: 20px;
  display: flex;
  gap: 12px;
}

#foto {
  width: 120px;
}

#head {
  flex: 1;
}

.head-stats {
  margin-top: 6px;
  font-size: 14px;
  color: #444;
}

.partido {
  margin-top: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid #ddd;
  font-size: 14px;
}
</style>
</head>

<body>

<input id="buscador" type="text" placeholder="Buscar futbolista…">
<div id="sugerencias"></div>

<div id="ficha">
  <img id="foto" src="" alt="">
  <div id="head">
    <h2 id="nombre"></h2>
    <div id="headStats" class="head-stats"></div>
  </div>
</div>

<hr>

<div id="detallePartidos"></div>

<script>
let jugadores = [];
let indiceActivo = -1;
let nombreJugador = "";

function parseMinuto(valor) {
  if (!valor) return null;
  valor = valor.toString().trim();
  if (valor.includes("+")) {
    const [b, e] = valor.split("+").map(Number);
    return b + e;
  }
  return Number(valor);
}

function debounce(fn, delay) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), delay);
  };
}

Papa.parse("Artids2000.csv", {
  download: true,
  header: true,
  complete: res => {
    res.data.forEach(r => {
      const once = r[Object.keys(r)[10]];
      if (!once) return;
      once.split(",").forEach(p => {
        const limpio = p.replace(/[()\d+]/g, "").trim();
        if (limpio && !jugadores.includes(limpio)) {
          jugadores.push(limpio);
        }
      });
    });
    jugadores.sort();
  }
});

const buscarLive = debounce(valor => {
  const cont = document.getElementById("sugerencias");
  cont.innerHTML = "";
  indiceActivo = -1;

  if (!valor) return;

  jugadores
    .filter(j => j.toLowerCase().includes(valor.toLowerCase()))
    .slice(0, 10)
    .forEach(j => {
      const d = document.createElement("div");
      d.className = "sugerencia";
      d.textContent = j;
      d.onclick = () => seleccionarJugador(j);
      cont.appendChild(d);
    });
}, 200);

document.getElementById("buscador").addEventListener("input", e => {
  buscarLive(e.target.value);
});

document.getElementById("buscador").addEventListener("keydown", e => {
  const items = document.querySelectorAll(".sugerencia");
  if (!items.length) return;

  if (e.key === "ArrowDown") {
    indiceActivo = (indiceActivo + 1) % items.length;
  } else if (e.key === "ArrowUp") {
    indiceActivo = (indiceActivo - 1 + items.length) % items.length;
  } else if (e.key === "Enter") {
    items[indiceActivo]?.click();
  }

  items.forEach(i => i.classList.remove("activa"));
  if (items[indiceActivo]) items[indiceActivo].classList.add("activa");
});

function seleccionarJugador(nombre) {
  nombreJugador = nombre;
  document.getElementById("buscador").value = nombre;
  document.getElementById("sugerencias").innerHTML = "";
  cargarFicha();
}

function cargarFicha() {
  let partidos = 0;
  let minutosTotales = 0;
  const detalle = [];

  Papa.parse("Artids2000.csv", {
    download: true,
    header: true,
    complete: res => {
      res.data.forEach(row => {
        const once = row[Object.keys(row)[10]] || "";
        const fin2T = parseMinuto(row["Fin2T"]);
        if (!fin2T) return;

        let esTitular = once.includes(nombreJugador);
        let ingreso = null;

        const reg = new RegExp("(\d+\+?\d*)\s+" + nombreJugador);
        const m = once.match(reg);
        if (m) {
          esTitular = false;
          ingreso = parseMinuto(m[1]);
        }

        if (!esTitular && ingreso == null) return;

        partidos++;
        const inicio = esTitular ? 0 : ingreso;
        const minutos = Math.max(0, fin2T - inicio);
        minutosTotales += minutos;

        detalle.push({
          tipo: esTitular ? "Titular" : "Suplente",
          minutos,
          rival: row["Rival"],
          resultado: row["Resultado"],
          tecnico: row["Técnico"]
        });
      });

      document.getElementById("nombre").textContent = nombreJugador;
      document.getElementById("headStats").textContent =
        partidos + " partidos · " + minutosTotales + " minutos";

      const cont = document.getElementById("detallePartidos");
      cont.innerHTML = "";
      detalle.forEach(p => {
        const d = document.createElement("div");
        d.className = "partido";
        d.innerHTML = "<strong>" + p.tipo + " (" + p.minutos + "')</strong><br>vs " +
          p.rival + " · " + p.resultado + "<br>DT: " + p.tecnico;
        cont.appendChild(d);
      });
    }
  });
}
</script>

</body>
</html>
